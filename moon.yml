language: "typescript"
type: "library"

tasks:
  build:
    command: "bun"
    args: ["tsc", "--project", "tsconfig.build.json"]
    inputs:
      - "src/**/*"
      - "tsconfig.json"
      - "tsconfig.build.json"
    outputs:
      - "dist/**/*"

  build-docs:
    command: "bun"
    args: ["typedoc"]
    deps: ["build"]
    inputs:
      - "src/**/*"
      - "typedoc.json"
      - "README.md"
    outputs:
      - "docs/api/**/*"

  clean:
    command: "bun"
    args: [
      "-e",
      "const fs = require('fs'); if (fs.existsSync('dist')) fs.rmSync('dist', {recursive: true, force: true})",
    ]

  dev:
    command: "bun"
    args: ["run", "--watch", "src/index.ts"]
    local: true

  dev-docs:
    command: "bunx"
    args: ["vitepress", "dev", "docs"]
    deps:
      - build-docs
    local: true

  docs:
    command: "bunx"
    args: ["vitepress", "dev", "docs"]
    deps:
      - build-docs
    local: true

  docs-build:
    command: "bunx"
    args: ["vitepress", "build", "docs"]
    deps:
      - build-docs
    inputs:
      - "docs/api/**/*"
      - "docs/.vitepress/**/*"
      - "docs/index.md"
      - "docs/guide/**/*"
    outputs:
      - "docs/.vitepress/dist/**/*"

  format:
    command: "dprint"
    args: ["fmt"]
    inputs:
      - "src/**/*"
      - "test/**/*"
      - "*.{json,md,yml,yaml}"
      - "biome.json"
      - "dprint.json"

  lint:
    command: "biome"
    args: ["check", "src", "test", "--no-errors-on-unmatched", "--write"]
    inputs:
      - "src/**/*"
      - "test/**/*"
      - "biome.json"

  prepack:
    deps:
      - clean
      - lint
      - format
      - build
      - test

  setup:
    command: "bun"
    args: ["run", "scripts/setup-reference.ts"]
    local: true
    env:
      GO_REPO: "https://github.com/rivo/uniseg"

  test:
    command: "bun"
    args: ["test"]
    inputs:
      - "src/**/*"
      - "test/**/*"

  version-bump-go:
    command: "bun"
    args: ["run", "scripts/bump-go-version.ts"]
    local: true

  version-bump-tsport:
    command: "bun"
    args: ["run", "scripts/bump-tsport-version.ts"]
    local: true
